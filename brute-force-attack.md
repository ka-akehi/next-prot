# ロードマップ（フェーズ別、ステップバイステップ）

## フェーズ 0 — 準備（1 日〜）

目的: ログ基盤と共有ストア（Redis）を用意して、計測できる状態にする

1. Redis インスタンスを用意（マネージド可）
2. 認証試行ログのスキーマを決める（timestamp, ip, username, path, user_agent, result）
3. ロギングパイプラインを確立（コンソール →Fluentd/Logstash/Datadog へ送る）
   - Next.js は `src/infrastructure/logging/auth-attempt-logger.ts` を介して `logs/auth-attempts.log`（NDJSON）へ認証イベントを出力し、Fluent Bit が `../next-prot/logs/*.log` を tail して集中収集する（スキーマは `types/auth-attempt-log.ts`）。
4. 開発環境に必要パッケージを追加（ioredis, bcrypt, dotenv など）

チェックポイント: Redis に接続できる / 最低限のログが収集できている

## フェーズ 1 — クイックウィン（1〜3 日）

目的: 一番効果が高く手早く導入できる防御を入れる（レートリミット + 一貫したエラーメッセージ）

1. Next.js の middleware.ts に IP ベースの簡易レートリミット（Redis 使用）を導入
2. API 側で統一されたエラーメッセージ（Invalid email or password 等）にする
3. パスワードチェックは bcrypt/argon2 に移行（既ユーザは段階的に再ハッシュ）
4. 監視ルール：1 分間に同 IP からの失敗 > X をアラート

チェックポイント: レートリミットで攻撃トラフィックが抑えられる / 監視でアラートが上がる

## フェーズ 2 — 強化（1〜2 週間）

目的: アカウント単位とデバイス/リスク判定を追加して攻撃耐性を高める

1. アカウント単位の失敗カウント（Redis）と指数バックオフの実装
2. CAPTCHA（閾値超過で発動）を導入（reCAPTCHA / hCaptcha など）
3. クレデンシャル・スタッフィング対応：登録/更新時に Pwned Passwords でチェック
4. ログイン成功時に失敗カウントをリセット

チェックポイント: 同一アカウントに対するなりすまし試行が減る / CAPTCHA でボットを弾ける

## フェーズ 3 — 完全運用（2〜4 週間）

目的: 分散攻撃・高度なターゲット化に対応できる体制を整備

1. Bot-management / CDN（Cloudflare 等）にボット対策ルールを追加
2. リスクベース認証（通常利用の場所/デバイスでなければ追加認証）を導入
3. MFA（TOTP / WebAuthn）導入と高価値アカウントの強制化
4. SIEM に長期ログを投入して長期トレンド分析・相関ルールを作る

チェックポイント: 分散攻撃が検出され自動遮断が入る / 高価値アカウントは MFA 必須

## フェーズ 4 — 運用・継続改善（継続）

1. 攻撃パターンデータを定期的に解析して閾値やブラックリストを更新
2. 自動対応（WAF ルールを自動生成）と人手対応のプレイブックを整備
3. ペンテスト・DAST を定期実行

チェックポイント: 定期的な攻撃検出レポートと改善施策が回っている
